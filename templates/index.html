<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="No-Cache">
    <meta http-equiv="refresh" content="600; URL=http://127.0.0.1:5000">

    <script type="text/javascript">
        let speak = (text) => {
            console.log(text)
            window.speechSynthesis.cancel()

            const speechMsg = new SpeechSynthesisUtterance()
            speechMsg.rate = 1
            speechMsg.pitch = 1
            speechMsg.lang = "ko-KR"
            speechMsg.text = text
            speechMsg.volume = 1

            console.log(speechMsg)

            window.speechSynthesis.speak(speechMsg)
        }

        function startTimer(time, idx) {
            let hour, min, sec;

            let timer = setInterval(function () {
              hour = parseInt(time/3600);
              min = parseInt(parseInt(time/60)%60);
              sec = time % 60;

              document.getElementById("laundryLeftTime"+idx).innerHTML
                  = hour + "<span style='font-size: 15px'>시간 </span>" +
                  min + "<span style='font-size: 15px'>분 </span>" +
                  sec + "<span style='font-size: 15px'>초 </span>";

              time--;

              if (time < 0) {
                clearInterval(timer);
                document.getElementById("laundryLeftTime"+idx).innerHTML = "빨래하세요!!";
                const header = document.getElementById("laundryLeftTime"+idx).parentNode.parentNode
                // header.parentNode.removeChild(header) 테스트 하느라 잠시 꺼둠
              }
            }, 1000);
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            if (ev.target.id == "div1"){
                document.getElementById(data).parentNode.removeChild(document.getElementById(data));
            } else {
                try {
                    ev.target.appendChild(document.getElementById(data));
                } catch(e) { }
            }
        }
    </script>

    <link rel="stylesheet" href="{{ url_for('static', filename='stylesheets/index.css') }}">
    <style>
        html, body{
            margin: 0
        }
    </style>
    <title>DIMI JA-SEUB</title>
</head>
<body>
    <img id="logo" src="https://i.imgur.com/OjEkXk9.png">

    <div id="div1" ondrop="drop(event)" ondragover="allowDrop(event)">

    </div>

    <div id="ingang">
        {% if ingangList %}
            {% for person in ingangList %}
                <div>
                    {{ person }}
                </div>
            {% endfor %}
        {% else %}
            <div>
                오늘은 인강실 가는 사람이 없네!?!?!?
            </div>
        {% endif %}
    </div>

    <div id="laundry" ondrop="drop(event)" ondragover="allowDrop(event)">
        {% if laundryList %}
            {% for person in laundryList %}
                {% if loop.first %}
                    <div id="laundryBox{{ loop.index }}" class="laundryBox" style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px;" draggable="true" ondragstart="drag(event)"
                    onclick="speak(document.getElementById('laundryTitle{{ loop.index }}').innerText +'님, 빨래하러 이동할 시간입니다')">
                    <div class="laundryLeft" style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px;"></div>
                    <div class="laundryRight">
                {% else %}
                    <div class="laundryBox" style="border-top-left-radius: 0px; border-top-right-radius: 0px"
                    onclick="speak(document.getElementById('laundryTitle{{ loop.index }}').innerText +'님, 빨래하러 이동할 시간입니다')">
                    <div class="laundryLeft" style="border-top-left-radius: 0px; border-top-right-radius: 0px;"></div>
                    <div class="laundryRight" style="border-top: 1px solid #eee;">
                {% endif %}
                        <div id="laundryTitle{{ loop.index }}" class="laundryTitle">
                            {{ person.name }}
                        </div>
                        <div class="laundryContent">
                            <div id="laundryContentText{{ loop.index }}" class="laundryContentText">{{ person.hour }}시 {{ person.minute }}분에 빨래를 예약하셨습니다</div>
                        </div>
                    </div>
                    {% if not loop.last %}
                        <div class="laundryLeftTime" style="border-bottom: 1px solid #eee;">
                    {% else %}
                        <div class="laundryLeftTime">
                    {% endif %}
                        <div id="laundryLeftTime{{ loop.index }}" class="laundryLeftTimeContent">
                            Loading...
                        </div>
                        <script>startTimer({{ person.left_time }}, {{ loop.index }})</script>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="laundryBox"
            onclick="speak(document.getElementById('laundryLeftTimeNONE').innerText)">
                <div class="laundryLeft"></div>
                <div class="laundryRight">
                    <div class="laundryTitle">
                        오늘은 신청자가 없어요
                    </div>
                    <div class="laundryContent">
                        <div id="laundryLeftTimeNONE" class="laundryContentText">
                            오늘은 신청자가 없다고 합니다
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</body>
</html>