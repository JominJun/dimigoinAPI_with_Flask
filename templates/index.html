<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="No-Cache">
    <meta http-equiv="refresh" content="600; URL=http://127.0.0.1:5000">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        let speak = (text) => {
            console.log(text)
            window.speechSynthesis.cancel()

            const speechMsg = new SpeechSynthesisUtterance()
            speechMsg.rate = 1
            speechMsg.pitch = 1
            speechMsg.lang = "ko-KR"
            speechMsg.text = text
            speechMsg.volume = 1

            console.log(speechMsg)

            window.speechSynthesis.speak(speechMsg)
        }

        function startTimer(time, idx) {
            let hour, min, sec;

            let timer = setInterval(function () {
              hour = parseInt(time/3600);
              min = parseInt(parseInt(time/60) % 60);
              sec = time % 60;

              try{
                  document.getElementById("laundryLeftTime"+idx).innerHTML
                  = hour + "<span style='font-size: 15px'>시간 </span>" +
                  min + "<span style='font-size: 15px'>분 </span>" +
                  sec + "<span style='font-size: 15px'>초 </span>";

                  time--;
              }catch (e){
                  clearInterval(timer)
              }


              if (time < 0) {
                try{
                    clearInterval(timer);
                    document.getElementById("laundryLeftTime"+idx).innerHTML = "빨래하세요!!";
                    const header = document.getElementById("laundryLeftTime"+idx).parentNode.parentNode
                    header.parentNode.removeChild(header)
                }  catch (e) {}
              }
            }, 1000);
        }

        let originParent = ""

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            originParent = ev.target.parentNode.id
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            try{
                ev.preventDefault();
                let data = ev.dataTransfer.getData("text");
                if (ev.target.id === "trashbin"){
                    document.getElementById(data).parentNode.removeChild(document.getElementById(data));
                } else {
                    //console.log(ev.target.id, originParent)
                    try {
                        if (ev.target.id === originParent){
                            ev.target.appendChild(document.getElementById(data));
                        }
                    } catch(e) { }
                }
            }catch(e) { }
        }
    </script>

    <link rel="stylesheet" href="{{ url_for('static', filename='stylesheets/index.css') }}">
    <style>
        html, body{
            margin: 0
        }
    </style>
    <title>DIMI JA-SEUB</title>
</head>
<body>
    <div id="trashbin" ondrop="drop(event)" ondragover="allowDrop(event)"> </div>

    인강실<br>
    물<br>
    화장실<br>
    방과후실<br>

    <div id="water"  ondrop="drop(event)" ondragover="allowDrop(event)">
        <div id="waterAddButton"></div>
    </div>

    <div id="ingang" ondrop="drop(event)" ondragover="allowDrop(event)">
        {% if ingangList %}
            {% for person in ingangList %}
                {% if now_time in person.time %}
                    <div id="ingangBox{{ loop.index }}" class="ingangBox" draggable="true" ondragstart="drag(event)">
                        <div class="ingangLeft" ondragstart="return false"></div>
                        <div class="ingangRight" ondragstart="return false">
                            <div id="ingangTitle{{ loop.index }}" class="ingangTitle">
                                {{ person.name }}
                            </div>
                            <div class="ingangContent">
                                <div id="ingangContentText{{ loop.index }}" class="ingangContentText">
                                    {% for i in person.time %}
                                        {% if loop.last %}{{ i }}타임 인강실 예약하셨습니다
                                        {% else %}{{ i }},
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div>
                        현재 시간에 인강실 신청한 사람이 없네?!??!
                    </div>
                    {% break %}
                {% endif %}
            {% endfor %}
        {% else %}
            <div>
                오늘은 인강실 가는 사람이 없네!?!?!?
            </div>
        {% endif %}
    </div>

    <div id="laundry" ondrop="drop(event)" ondragover="allowDrop(event)">
        {% if laundryList %}
            {% for person in laundryList %}
                <div id="laundryBox{{ loop.index }}" class="laundryBox"
                    draggable="true" ondragstart="drag(event)"
                    onclick="speak(document.getElementById('laundryTitle{{ loop.index }}').innerText +'님, 빨래하러 이동할 시간입니다')">
                <div class="laundryLeft"></div>
                {% if loop.first %}
                    <div class="laundryRight">
                {% else %}
                    <div class="laundryRight" style="border-top: 1px solid #eee;">
                {% endif %}
                        <div id="laundryTitle{{ loop.index }}" class="laundryTitle">
                            {{ person.name }}
                        </div>
                        <div class="laundryContent">
                            <div id="laundryContentText{{ loop.index }}" class="laundryContentText">{{ person.hour }}시 {{ person.minute }}분에 빨래를 예약하셨습니다</div>
                        </div>
                    </div>
                    {% if not loop.last %}
                        <div class="laundryLeftTime" style="border-bottom: 1px solid #eee;">
                    {% else %}
                        <div class="laundryLeftTime">
                    {% endif %}
                        <div id="laundryLeftTime{{ loop.index }}" class="laundryLeftTimeContent">
                            Loading...
                        </div>
                        <script>startTimer({{ person.left_time }}, {{ loop.index }})</script>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="laundryBox"
            onclick="speak(document.getElementById('laundryLeftTimeNONE').innerText)">
                <div class="laundryLeft"></div>
                <div class="laundryRight">
                    <div class="laundryTitle">
                        오늘은 신청자가 없어요
                    </div>
                    <div class="laundryContent">
                        <div id="laundryLeftTimeNONE" class="laundryContentText">
                            오늘은 신청자가 없다고 합니다
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        cnt = 0

        $("#waterAddButton").click(() => {
            let inp = prompt("이름을 입력해주세요")
            if (inp){
                $("#water").append("<div id='waterBox"+cnt+"' class='waterBox' draggable='true' ondragstart='drag(event)'>\
                    <div class='waterLeft'></div> \
                    <div class='waterRight'>\
                        <div class='waterTitle'>\
                            "+inp+"\
                        </div>\
                        <div class='waterContent'>\
                            <div class='waterContentText'>\
                                🎵 깊은 산 속 옹달샘 누가 왔다 가나요 🎵\
                            </div>\
                        </div>\
                    </div>\
                </div>");

                cnt++;
            }else{
                alert("이름이 없어요~~")
            }
        });
    </script>
</body>
</html>